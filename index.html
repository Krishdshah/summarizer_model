<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Search & Summarizer</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 2rem; background-color: #f0f2f5; }
        .container { max-width: 800px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; }
        .input-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        input[type="text"] { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        button { display: block; width: 100%; padding: 0.75rem; border: none; border-radius: 6px; background-color: #1877f2; color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        button:hover { background-color: #166fe5; }
        .result-item { padding: 1.5rem; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 1rem; }
        .summarize-btn { background-color: #42b72a; margin-top: 1rem; font-size: 0.9rem; padding: 0.5rem 1rem; width: auto; }
        .summarize-btn:hover { background-color: #36a420; }
        .summary { margin-top: 1rem; padding: 1rem; background-color: #e9ebee; border-radius: 6px; white-space: pre-wrap; }
        .status { text-align: center; color: #606770; font-size: 1rem; margin-top: 2rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”¬ PDF Search & Summarizer</h1>
        <div class="input-group">
            <label for="apiUrl">API URL</label>
            <input type="text" id="apiUrl" placeholder="https://your-service-name.onrender.com">
        </div>
        <div class="input-group">
            <label for="searchQuery">Search Query</label>
            <input type="text" id="searchQuery" placeholder="e.g., bone loss in space">
        </div>
        <button onclick="handleSearch()">Search</button>
        <div id="results"></div>
        <div id="status"></div>
    </div>

    <script>
        const apiUrlInput = document.getElementById('apiUrl');
        const searchQueryInput = document.getElementById('searchQuery');
        const resultsDiv = document.getElementById('results');
        const statusDiv = document.getElementById('status');

        async function handleSearch() {
            const baseUrl = apiUrlInput.value.trim();
            const query = searchQueryInput.value.trim();
            if (!baseUrl || !query) { alert("Please provide both API URL and a search query."); return; }

            statusDiv.textContent = "Searching...";
            resultsDiv.innerHTML = "";

            try {
                const response = await fetch(`${baseUrl}/search/?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                displayResults(data.results);
            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
            }
        }

        function displayResults(results) {
            if (results.length === 0) { statusDiv.textContent = "No documents found."; return; }
            statusDiv.textContent = "";

            results.forEach((item, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.id = `result-${index}`;
                resultItem.innerHTML = `
                    <h3>${item.title}</h3>
                    <p><strong>Relevance Score:</strong> ${item.relevance_score.toFixed(2)}</p>
                    <p><a href="${item.link}" target="_blank">Read Original Article</a></p>
                    <button class="summarize-btn" onclick="handleSummarize('${item.pdf_filename}', 'result-${index}')">
                        Generate Summary
                    </button>
                    <div class="summary-container"></div>
                `;
                resultsDiv.appendChild(resultItem);
            });
        }

        // --- UPDATED FUNCTION ---
        async function handleSummarize(filename, resultId) {
            const baseUrl = apiUrlInput.value.trim();
            const resultItem = document.getElementById(resultId);
            const summaryContainer = resultItem.querySelector('.summary-container');
            if (!baseUrl) { alert("Please provide the API URL."); return; }

            summaryContainer.innerHTML = `<p class="status">Generating summary... This may take up to a minute.</p>`;

            try {
                // Set a timeout on the fetch request itself (e.g., 120 seconds)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 120 seconds

                const response = await fetch(`${baseUrl}/summarize/?filename=${encodeURIComponent(filename)}`, {
                    signal: controller.signal
                });

                clearTimeout(timeoutId); // Clear the timeout if the request succeeds

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                summaryContainer.innerHTML = `<div class="summary">${data.summary}</div>`;
            } catch (error) {
                if (error.name === 'AbortError') {
                    summaryContainer.innerHTML = `<p class="status">Error: The request timed out. The server is taking too long to respond.</p>`;
                } else {
                    summaryContainer.innerHTML = `<p class="status">Error: ${error.message}</p>`;
                }
            }
        }
    </script>
</body>
</html>